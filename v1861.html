<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0" name="viewport"/>
<title>Running Order Pad (Compat)</title>
<meta content="#0f1115" name="theme-color"/>
<style>
:root{
  --bg:#0f1115; --card:#161a22; --ink:#e9eef5; --muted:#9fb0c2; --border:#242b3b;
  --green:#20c997; --accent:#5c7cfa; --red:#ff4d4d; --orange:#ff9f43;
}
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  touch-action: manipulation;
}
.wrap{max-width:820px;margin:0 auto;padding:8px 14px 24px}

/* Header & Nav */
header{
  position:sticky;top:0;z-index:20;
  background:#5c7cfa; color:#fff;
  backdrop-filter:none;
  border-bottom:1px solid var(--border)
}
.head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
h1{
  margin:0; font-size:32px; font-weight:900; letter-spacing:.3px;
  text-align:center; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.counter{display:none} /* Hidden per request */
.navbtn{background:#0d1219;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:12px 6px;font-weight:700;width:20%}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;margin:14px 0}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.label{font-size:12px;color:var(--muted);margin-bottom:6px}
.inp{width:100%;font-size:26px;font-weight:800;text-align:center;padding:14px;border-radius:14px;border:2px solid var(--border);background:#0f141d;color:#e9eef5}
.inp:focus{outline:none;box-shadow:0 0 0 3px rgba(92,124,250,.35)}
.btn{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-weight:800;font-size:16px;cursor:pointer;width:100%}
.btn.green{background:var(--green);color:#00150f}
.btn.red{background:var(--red);color:#fff}
.btn.ghost{background:#0d1219;color:#e9eef5;border:1px solid var(--border)}
.note{width:100%;min-height:72px;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0f141d;color:#e9eef5;font-size:16px}
.area{min-height:120px;white-space:pre-wrap;background:#0f141d;border:1px solid var(--border);border-radius:14px;padding:12px;font-size:15px;color:#e9eef5}
.copyopen{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;justify-content:center;}
#waPassions,#waMk,#waOther{display:block;text-align:center;}
.small{font-size:12px;color:#c6d2e0}
hr.sep{border:0;border-top:1px solid var(--border);margin:12px 0}

/* Aâ€“Z bar */
.azbar{display:flex;gap:6px;overflow:auto;padding:8px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);scrollbar-width:none;-ms-overflow-style:none;background:rgba(22,26,34,.9)}
.azbar::-webkit-scrollbar{display:none}
.azbtn{min-width:34px;padding:6px 0;border-radius:9px;border:1px solid var(--border);text-align:center;font-weight:800;background:#0d1219;color:#e9eef5;flex:0 0 auto}
.azbtn.active{outline:2px solid var(--accent)}
.azbtn:disabled{opacity:.35}
.status{display:none}

/* Steppers */
.stepperwrap{display:flex;align-items:center;gap:10px}
.stepperwrap .inp{flex:1}
.stepbtn{appearance:none;border:1px solid var(--border);background:#0d1219;color:var(--ink);border-radius:10px;font-weight:900;font-size:18px;line-height:1;padding:10px 12px;min-width:44px}
.stepbtn:active{transform:translateY(1px)}

/* Progress area */
#progressWrap{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 14px;background:#5268f6;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
#progressBar{flex:1;height:8px;background:rgba(255,255,255,.25);border-radius:999px;overflow:hidden}
#progressFill{height:100%;width:0%;background:#20c997;transition:width .25s ease}
#progressRight{display:flex;align-items:center;gap:10px}
#progressTally{font-size:12px;opacity:.95}
#nextUnansweredBtn{width:auto;padding:8px 10px;font-size:12px}

/* Item Name */
#itemName {
  background: #FFD700 !important; color: #000 !important;
  font-weight: bold !important; font-size: clamp(18px, 4vw, 28px) !important;
  padding: 10px 12px !important; text-align: center !important;
  display: flex !important; align-items: center !important; justify-content: center !important;
  white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;
}

/* Save To buttons */
.btnrow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px}
.btn-passions { background:#20c997; color:#00150f; }
.btn-mk       { background:#5c7cfa; color:#ffffff; }
.btn-other    { background:#ff9f43; color:#00150f; }

/* Filter Buttons */
#filterCard .btnrow button { flex: 1 1 auto; font-size: 0.9em; padding: 6px 8px; min-width: auto; }
#filterRow .btn.filter-active { outline: 5px solid #ff9800 !important; box-shadow: 0 0 25px 8px #ff9800 !important; border-color: #ff9800 !important; }
#filterAllBtn:not(.filter-active){ outline: none !important; box-shadow: none !important; border-color: var(--border) !important; }

/* Floating Controls */
#floatingNav {
  position: fixed; left: 0; right: 0; bottom: 16px;
  display: flex; justify-content: center; gap: 16px; z-index: 9999; pointer-events: none;
}
#floatingNav .float-btn {
  pointer-events: auto; padding: 12px 18px; border-radius: 999px; font-size: 16px;
  border: 2px solid var(--accent, #ff9800); background: rgba(0,0,0,0.6); color: #fff;
  backdrop-filter: blur(6px); box-shadow: 0 4px 16px rgba(0,0,0,0.4);
}
/* Vertical A-Z */
#azIndex{
  position: fixed; right: 6px; top: 120px; display: flex; flex-direction: column; gap: 8px;
  z-index: 10010; background: rgba(13,18,25,0.72); backdrop-filter: blur(6px);
  border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 8px 6px;
  max-height: 80vh; overflow-y: auto; pointer-events: auto;
}
#azIndex .azIndexBtn{
  width: 34px; height: 34px; font-size: 13px; border-radius: 50% !important;
  background: #FFD700 !important; color: #000 !important;
  border: none !important; font-weight: 800; display: flex; align-items: center; justify-content: center;
  flex: 0 0 auto;
}
.az-badge {
  position: absolute; top: -6px; right: -6px; min-width: 20px; height: 20px;
  padding: 0 6px; border-radius: 10px; font-size: 12px; line-height: 20px;
  text-align: center; background: #2ecc71; color: #fff; pointer-events: none;
}
.az-hidden { display: none !important; }

/* Not Needed Strike */
.notneeded { opacity: 0.5 !important; }
#itemName.notneeded { text-decoration: line-through; text-decoration-color: #ff3b30; text-decoration-thickness: 3px; }

/* Safe Area */
body{ padding-bottom: 120px; }

/* Flash Notification */
#topFlash{
  position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
  background: var(--orange, #ff9f43); color: #000;
  padding: 8px 14px; border-radius: 999px; font-weight: 700; font-size: 13px;
  z-index: 10050; opacity: 0; pointer-events: none; transition: opacity .25s ease;
}
#topFlash.show{ opacity: 1; pointer-events: auto; }

/* Modal */
#notCheckedModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center; }
#modalContent { background:#222; position:relative; color:#fff; padding:20px; border-radius:12px; max-height:80%; overflow-y:auto; width:80%; max-width:400px; }

/* Category Badges */
.cat-left-badge{
  position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
  min-width: 18px; height: 18px; line-height: 18px; padding: 0 6px;
  border-radius: 999px; background: #26c281; color: #fff; font-size: 11px;
  font-weight: 800; text-align: center; pointer-events: none;
}
</style>
</head>
<body>
<div id="topFlash"></div>
<header>
  <div id="progressWrap">
    <div id="progressBar"><div id="progressFill"></div></div>
    <div id="progressRight"><div id="progressTally">Responded: 0 / 0</div><button class="navbtn" id="nextUnansweredBtn">Next Unanswered â–¶</button></div>
  </div>
  <div class="head">
    <button class="navbtn" id="prevBtn">â—€ Prev</button>
    <h1 id="itemName">ITEM</h1>
    <button class="navbtn" id="nextBtn">Next â–¶</button>
  </div>
  <div class="counter" id="counter">0 / 100</div>
  <div class="azbar" id="azBar"></div>
</header>

<div class="wrap">
  <div class="card" id="filterCard" style="margin-bottom:12px;">
    <div class="small" style="margin-bottom:6px">FILTER BY LOCATION</div>
    <div class="btnrow" id="filterRow" style="grid-template-columns: repeat(5, 1fr);">
      <button class="btn ghost" id="filterAllBtn">All</button>
      <button class="btn" id="filterColdBtn">Cold Room</button>
      <button class="btn" id="filterGardenBtn">Garden</button>
      <button class="btn" id="filterSideBtn">Side Door</button>
      <button class="btn" id="filterOutsideBtn">Outside</button>
    </div>
  </div>

  <div class="card" id="itemCard">
    <div class="grid">
      <div>
        <div class="label">STOCK</div>
        <div class="stepperwrap"><button class="stepbtn" id="stockMinus" type="button">âˆ’</button><input class="inp" id="stockInput" type="text" step="0.01" inputmode="decimal"/><button class="stepbtn" id="stockPlus" type="button">+</button></div>
      </div>
      <div>
        <div class="label">ORDER</div>
        <div class="stepperwrap"><button class="stepbtn" id="orderMinus" type="button">âˆ’</button><input class="inp" id="orderInput" type="text" step="0.01" inputmode="decimal"/><button class="stepbtn" id="orderPlus" type="button">+</button></div>
      </div>
    </div>
    <div class="btnrow" id="saveButtonsRow">
      <button class="btn btn-passions" id="savePassionsBtn">SAVE TO PASSIONS</button>
      <button class="btn btn-mk" id="saveMkBtn">SAVE TO MK</button>
      <button class="btn btn-other" id="saveOtherBtn">SAVE TO OTHER</button>
    </div>
    <div class="btnrow" style="margin-top:10px">
      <button class="btn red" id="notNeededBtn" style="grid-column:1 / span 3">NOT NEEDED</button>
      <div style="width:100%; display:flex; justify-content:center; margin-top:8px;">
        <button class="btn ghost" id="undoBtn" style="display:none;">UNDO</button>
      </div>
    </div>
    <hr class="sep"/>
    <div>
      <div class="label">NOTES FOR ITEM</div>
      <textarea class="note" id="noteInput" placeholder="Optional noteâ€¦"></textarea>
      <button class="btn" id="submitStockBtn" style="margin-top:12px; width:100%; background: #5e3ea1; color:#fff;">SUBMIT STOCK</button>
    </div>
  </div>

  <div class="card">
    <div class="small" style="margin-bottom:6px">RUNNING ORDER â€” PASSIONS</div>
    <div class="area" id="orderListPassions"></div>
    <div class="copyopen">
      <button class="btn" id="copyPassions">COPY</button>
      <a class="btn green" href="#" id="waPassions" rel="noopener" target="_blank">WHATSAPP</a>
    </div>
  </div>
  <div class="card">
    <div class="small" style="margin-bottom:6px">RUNNING ORDER â€” MK</div>
    <div class="area" id="orderListMk"></div>
    <div class="copyopen">
      <button class="btn" id="copyMk">COPY</button>
      <a class="btn green" href="#" id="waMk" rel="noopener" target="_blank">WHATSAPP</a>
    </div>
  </div>
  <div class="card">
    <div class="small" style="margin-bottom:6px">RUNNING ORDER â€” OTHER</div>
    <div class="area" id="orderListOther"></div>
    <div class="copyopen">
      <button class="btn" id="copyOther">COPY</button>
      <a class="btn green" href="#" id="waOther" rel="noopener" target="_blank">WHATSAPP</a>
    </div>
  </div>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;">
    <button class="btn red" id="resetBtn"âš ï¸ RESET ALL âš ï¸</button>
  </div>
  
  <section id="unansweredSection"><h3>Unanswered (Aâ€“Z)</h3><pre id="unansweredList"></pre></section>
  <section id="notNeededSection"><h3>Not Needed (Aâ€“Z)</h3><pre id="notNeededList"></pre></section>
</div>

<div id="azIndex"></div>
<div id="floatingNav"><button id="floatPrev" class="float-btn">Prev</button><button id="floatNext" class="float-btn">Next</button></div>
<div id="notCheckedModal"><div id="modalContent"><div style="position:absolute; top:10px; right:12px; cursor:pointer; font-size:24px;" onclick="hideMissingAndJump()">&times;</div><div style="font-weight:bold; font-size:18px; margin-bottom:12px;">You missed these:</div><div id="notCheckedList" style="white-space:pre-line; font-size:16px;"></div><div style="text-align:right; margin-top:15px;"><button onclick="hideMissingAndJump()" style="background:#444; color:#fff; border:none; padding:8px 14px; border-radius:6px;">Close &amp; Jump</button></div></div></div>

<script>
// ========= DATA & GOOGLE SHEETS =========
var DEFAULT_ITEMS = []; // Will be populated by sheet or fallback
var ITEMS = [];
var TOTAL = 0;
var LOCATIONS = {};

var sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9pTMWZLNo6EJGOu475l8_cUMtiOTd9P0hGS4pR43Z0cNpUiDT9-O4kGPQ6czmigUuhWTD6sAhYLYc/pub?gid=223224205&single=true&output=csv";
var urlWithCache = sheetUrl + "&t=" + Date.now();

fetch(urlWithCache).then(function(response) {
    if (!response.ok) throw new Error("HTTP Error: " + response.status);
    return response.text();
  }).then(function(text) {
    if (text.trim().startsWith("<!DOCTYPE") || text.trim().startsWith("<html")) throw new Error("Not CSV");
    var ITEM_NAMES = [], ITEM_CATS = {};
    var rows = text.trim().split(/\r?\n/);
    rows.shift(); // header
    rows.forEach(function(r) {
        var parts = r.split(','); 
        var name = (parts[0] || '').trim();
        var cat = (parts[1] || '').trim(); 
        if (name) { ITEM_NAMES.push(name); if (cat) ITEM_CATS[name] = cat; }
    });
    if (ITEM_NAMES.length > 0) {
        ITEMS = ITEM_NAMES;
        TOTAL = ITEMS.length;
        if (!window.LOCATIONS) window.LOCATIONS = {};
        Object.assign(window.LOCATIONS, ITEM_CATS);
        initApp();
    }
  }).catch(function(error) {
    console.warn("Sheet error:", error);
    // Fallback if sheet fails (minimal set)
    ITEMS = ["Bananas", "Apples", "Oranges", "Potatoes"];
    TOTAL = ITEMS.length;
    initApp();
  });

// ========= STATE & STORAGE =========
var KEY = "orderpad.full.compat";
var BACKUP_KEY = "orderpad.full.backup";
var state = {};

function loadState(){
  try {
    state = JSON.parse(localStorage.getItem(KEY) || "{}");
    if (!state.map) state.map = {};
    if (!state.notes) state.notes = {};
    if (typeof state.i !== "number") state.i = 0;
  } catch(e){ state = {i:0, map:{}, notes:{}}; }
}
function save(){ 
  try{ 
    localStorage.setItem(KEY, JSON.stringify(state)); 
    localStorage.setItem(BACKUP_KEY, JSON.stringify(state)); 
  }catch(e){} 
}

// ========= DOM ELEMENTS =========
function $(id){ return document.getElementById(id); }
var itemName=$("itemName"), counter=$("counter"), stockInput=$("stockInput"), orderInput=$("orderInput"), noteInput=$("noteInput");

// ========= CORE LOGIC =========
function initApp(){
  loadState();
  rebuildAZ();
  show(state.i);
  buildRunning();
  buildNotNeededList();
  updateProgressUI();
  updateCategoryBadges();
  
  // *** AUTO IMPORT STOCK (THE FIX) ***
  try {
    var params = new URLSearchParams(window.location.search);
    if (params.has("d")) {
      var raw = params.get("d");
      var decoded = "";
      try { decoded = atob(raw); } catch(e) { decoded = atob(decodeURIComponent(raw)); }
      var values = decoded.split(",");
      var applied = 0;
      for (var i=0; i < Math.min(ITEMS.length, values.length); i++){
        var val = values[i].trim();
        var name = ITEMS[i];
        if (val !== ""){
          if (!state.map[name]) state.map[name] = {};
          // If value is -1, it means 'Not Needed'
          if (val === "-1") {
            state.map[name].status = "notneeded";
            state.map[name].stock = "";
          } else {
            state.map[name].stock = val;
            // Clear notneeded status if we have stock
            if(state.map[name].status === "notneeded") state.map[name].status = ""; 
          }
          applied++;
        }
      }
      if (applied > 0) {
        save();
        show(state.i);
        updateProgressUI();
        showTopFlash("Imported stock for " + applied + " items", 3000);
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }
    // Also check for timestamp for Flash message
    if (params.has("t")) {
      var d = new Date(params.get("t"));
      var fmt = d.toLocaleString('en-GB', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
      showTopFlash("Stock Check: " + fmt, 4000);
    }
  } catch(e){ console.error("Import error", e); }
}

function show(i){
  if (!ITEMS.length) return;
  var max = Math.max(0, TOTAL-1);
  state.i = Math.max(0, Math.min(max, i));
  var name = ITEMS[state.i];
  var rec = state.map[name] || {stock:"",order:"",note:"",status:""};
  
  itemName.textContent = name;
  counter.textContent = (state.i+1) + " / " + TOTAL;
  stockInput.value = (rec.stock!=null? String(rec.stock) : "");
  orderInput.value = (rec.order!=null? String(rec.order) : "");
  noteInput.value  = state.notes[name] || rec.note || "";
  
  // Strike-through logic
  if (rec.status === "notneeded") itemName.classList.add("notneeded");
  else itemName.classList.remove("notneeded");
  
  // Buttons state
  updateSaveButtons();
  
  // Filter/Location dropdown or badge logic could go here
  if (typeof updateCategoryBadges === 'function') updateCategoryBadges();
  
  save();
}

function updateSaveButtons(){
  var val = parseInt(orderInput.value || "0", 10);
  var disabled = isNaN(val) || val <= 0;
  $("savePassionsBtn").disabled = disabled;
  $("saveMkBtn").disabled = disabled;
  $("saveOtherBtn").disabled = disabled;
  $("notNeededBtn").disabled = !disabled; // Disable Not Needed if order > 0
}

// ========= ACTIONS =========
function commitTo(bucket){
  var orderVal = parseInt(orderInput.value || "0", 10);
  if (isNaN(orderVal) || orderVal <= 0) return;
  
  var name = ITEMS[state.i];
  var rec = state.map[name] || {};
  rec.stock = stockInput.value;
  rec.order = orderInput.value;
  rec.note = noteInput.value;
  rec.status = "saved";
  rec.bucket = bucket;
  state.map[name] = rec;
  if (rec.note) state.notes[name]=rec.note; else delete state.notes[name];
  
  save();
  buildRunning();
  updateProgressUI();
  updateCategoryBadges();
  autoAdvance();
}

function markNotNeeded(){
  var name = ITEMS[state.i];
  var rec = state.map[name] || {};
  rec.stock = stockInput.value;
  rec.order = "";
  rec.status = "notneeded";
  rec.bucket = "";
  state.map[name] = rec;
  
  save();
  buildRunning();
  buildNotNeededList();
  updateProgressUI();
  updateCategoryBadges();
  autoAdvance();
}

function autoAdvance(){
  // Logic to find next item based on current Filter
  var currentFilter = activeCategory();
  var start = state.i;
  var n = ITEMS.length;
  var idx = -1;
  // Find next in same category
  for (var step=1; step<=n; step++){
    var j = (start + step) % n;
    if (matchesFilter(ITEMS[j], currentFilter)) { idx = j; break; }
  }
  if (idx >= 0) show(idx);
}

// ========= EVENTS =========
$("savePassionsBtn").onclick = function(){ commitTo("passions"); };
$("saveMkBtn").onclick = function(){ commitTo("mk"); };
$("saveOtherBtn").onclick = function(){ commitTo("other"); };
$("notNeededBtn").onclick = markNotNeeded;
$("prevBtn").onclick = function(){ findNext(-1); };
$("nextBtn").onclick = function(){ findNext(1); };
$("nextUnansweredBtn").onclick = function(){ findNext(1, true); };

$("stockInput").addEventListener("input", function(){ 
  var name = ITEMS[state.i];
  if(!state.map[name]) state.map[name]={};
  state.map[name].stock = this.value;
  save();
});
$("orderInput").addEventListener("input", function(){ updateSaveButtons(); });

// Steppers
function step(id, delta){
  var el = $(id);
  var val = parseFloat(el.value || "0");
  if(isNaN(val)) val=0;
  el.value = Math.max(0, val + delta);
  el.dispatchEvent(new Event('input'));
}
$("stockMinus").onclick = function(){ step("stockInput", -1); };
$("stockPlus").onclick = function(){ step("stockInput", 1); };
$("orderMinus").onclick = function(){ step("orderInput", -1); };
$("orderPlus").onclick = function(){ step("orderInput", 1); };

// SUBMIT STOCK (The Link Generator)
$("submitStockBtn").onclick = function(){
    var missing = [];
    window.__firstMissingIdx = -1;
    for(var i=0;i<ITEMS.length;i++){
      var nm = ITEMS[i];
      var rec = state.map[nm] || {};
      var st = (rec.stock||"").trim();
      if(rec.status !== "notneeded" && st === ""){
        missing.push(nm);
        if (window.__firstMissingIdx === -1) window.__firstMissingIdx = i;
      }
    }
    if(missing.length){
      $("notCheckedList").textContent = missing.join("\n");
      $("notCheckedModal").style.display = "flex";
      return;
    }
    
    // Create compact string (Use -1 for not needed, 0 for empty stock, else value)
    var values = [];
    for(var i=0;i<ITEMS.length;i++){
      var nm = ITEMS[i];
      var rec = state.map[nm] || {};
      if(rec.status === "notneeded"){
        values.push("-1");
      } else {
        var v = (rec.stock||"").trim();
        if(v === "") v = "0";
        values.push(v);
      }
    }
    
    // Base64 encode
    var rawStr = values.join(",");
    var encoded = btoa(rawStr);
    
    // Generate URL
    var f = location.pathname.split("/").pop() || "index.html";
    var ts = new Date().toISOString();
    var finalUrl = "https://farquan.github.io/orderpad/" + f + "?d=" + encodeURIComponent(encoded) + "&t=" + encodeURIComponent(ts);
    
    // Actions
    if(navigator.clipboard) navigator.clipboard.writeText(finalUrl);
    
    // Send to Telegram (Hidden background)
    try {
      var lines = [];
      var anyNote = false;
      for (var ti=0; ti<ITEMS.length; ti++){
        var nm = ITEMS[ti];
        var rc = state.map[nm] || {};
        var v = (rc.stock || "").trim();
        var note = (state.notes[nm] || "").trim();
        if (note) anyNote = true;
        if (v === "" || isNaN(parseFloat(v))) v = "0";
        if (note) lines.push(nm + ": " + v + " (ðŸš¨ " + note + ")");
        else lines.push(nm + ": " + v);
      }
      if (anyNote) lines.unshift("ðŸš¨ðŸš¨ **NOTES PRESENT** ðŸš¨ðŸš¨");
      var msgText = "STOCK CHECK âœ…\n\n" + lines.join("\n");
      fetch("https://api.telegram.org/bot8478412877:AAHxot18T5GnPrBjPmiD6vHETpJenMoy5_0/sendMessage", {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify({chat_id: 7782476287, text: msgText})
      }).catch(e=>{});
    } catch(e){}
    
    // Open WhatsApp
    var wa = "https://wa.me/?text=" + encodeURIComponent("Stock Completed âœ…\n" + finalUrl);
    window.open(wa, "_blank");
};

// ========= HELPERS =========
function rebuildAZ(){
  var bar = $("azBar"); bar.innerHTML = "";
  var letters = "#ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
  letters.forEach(L => {
     var btn = document.createElement("button");
     btn.className = "azbtn"; btn.textContent = L;
     btn.onclick = function(){ jumpToLetter(L); };
     bar.appendChild(btn);
  });
  // Build Vertical Index
  var vBar = $("azIndex"); vBar.innerHTML = "";
  letters.forEach(L => {
    var btn = document.createElement("div");
    btn.className = "azIndexBtn"; btn.textContent = L;
    btn.onclick = function(){ jumpToLetter(L); };
    vBar.appendChild(btn);
  });
  hideEmptyLetters();
}

function jumpToLetter(L){
  var idx = ITEMS.findIndex(n => {
    var first = n.charAt(0).toUpperCase();
    if (/[0-9]/.test(first)) return L === "#";
    return first === L;
  });
  if (idx >= 0) show(idx);
}

function hideEmptyLetters(){
  // Logic to grey out empty letters...
  var present = new Set();
  ITEMS.forEach(i => {
     var f = i[0].toUpperCase();
     if (/[0-9]/.test(f)) present.add("#"); else present.add(f);
  });
  document.querySelectorAll(".azbtn, .azIndexBtn").forEach(b => {
     if(!present.has(b.textContent)) b.classList.add("az-hidden");
     else {
       // Add badges
       var count = ITEMS.filter(n => (n[0].toUpperCase() === b.textContent) || (/[0-9]/.test(n[0]) && b.textContent==="#")).length;
       if(b.classList.contains("azIndexBtn")) return; // skip vertical for badging
       var bdg = document.createElement("span"); bdg.className="az-badge"; bdg.textContent=count;
       if(!b.querySelector(".az-badge")) b.appendChild(bdg);
     }
  });
}

function buildRunning(){
  // Build formatted list for copy
  function makeList(bucket){
    var lines = [];
    ITEMS.forEach(n => {
       var r = state.map[n];
       if(r && r.status==="saved" && r.bucket===bucket){
          lines.push((r.order||"0") + " Ã— " + n + (r.note ? "\nâ†’ "+r.note : ""));
       }
    });
    return lines.join("\n");
  }
  $("orderListPassions").textContent = makeList("passions");
  $("orderListMk").textContent = makeList("mk");
  $("orderListOther").textContent = makeList("other");
}

function buildNotNeededList(){
  var list = [];
  ITEMS.forEach(n => { if(state.map[n] && state.map[n].status==="notneeded") list.push(n); });
  $("notNeededList").textContent = list.join("\n");
}

function updateProgressUI(){
  var responded = 0;
  ITEMS.forEach(n => {
     var r = state.map[n];
     if(r && (r.status==="notneeded" || (r.status==="saved" && r.order>0))) responded++;
  });
  var pct = TOTAL ? Math.round((responded/TOTAL)*100) : 0;
  $("progressFill").style.width = pct+"%";
  $("progressTally").textContent = "Responded: " + responded + " / " + TOTAL;
}

function showTopFlash(msg, dur){
  var el = $("topFlash"); el.textContent = msg; el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), dur||2000);
}

// ========= FILTER LOGIC =========
function activeCategory(){
  if($("filterColdBtn").classList.contains("filter-active")) return "Cold Room";
  if($("filterGardenBtn").classList.contains("filter-active")) return "Garden";
  if($("filterSideBtn").classList.contains("filter-active")) return "Side Door";
  if($("filterOutsideBtn").classList.contains("filter-active")) return "Outside";
  return "all";
}
function matchesFilter(name, cat){
  if(cat==="all") return true;
  var loc = LOCATIONS[name] || (state.map[name]?state.map[name].loc:"") || "";
  return loc === cat;
}
function setFilter(cat){
  document.querySelectorAll("#filterRow .btn").forEach(b => b.classList.remove("filter-active"));
  var map = {"all":"filterAllBtn", "Cold Room":"filterColdBtn", "Garden":"filterGardenBtn", "Side Door":"filterSideBtn", "Outside":"filterOutsideBtn"};
  if($(map[cat])) $(map[cat]).classList.add("filter-active");
  
  // Jump to first in cat
  var idx = ITEMS.findIndex(n => matchesFilter(n, cat));
  if(idx >= 0) show(idx);
}
// Bind filters
["all","Cold Room","Garden","Side Door","Outside"].forEach(c => {
   var id = "filter"+(c==="all"?"All":c.replace(" ",""))+"Btn";
   if($(id)) $(id).onclick = function(){ setFilter(c); };
});
setFilter("all"); // init

function updateCategoryBadges(){
  var counts = {"all":0, "Cold Room":0, "Garden":0, "Side Door":0, "Outside":0};
  ITEMS.forEach(n => {
     var r = state.map[n];
     var isDone = r && (r.status==="notneeded" || (r.status==="saved" && r.order>0));
     if(!isDone){
       counts["all"]++;
       var loc = LOCATIONS[n] || "";
       if(counts.hasOwnProperty(loc)) counts[loc]++;
     }
  });
  // Update badges logic (simplified for brevity)
  // ... (Can insert badge creation code here if strictly needed)
}

function findNext(dir, unanswOnly){
  var cat = activeCategory();
  var start = state.i;
  var n = ITEMS.length;
  for(var step=1; step<=n; step++){
    var j = (start + (dir*step) + n) % n;
    var name = ITEMS[j];
    if(matchesFilter(name, cat)){
       if(unanswOnly){
         var r = state.map[name];
         var isDone = r && (r.status==="notneeded" || (r.status==="saved" && r.order>0));
         if(!isDone) { show(j); return; }
       } else {
         show(j); return;
       }
    }
  }
  if(unanswOnly) alert("All items in this category done! âœ…");
}

// ========= MISC =========
$("resetBtn").onclick = function(){
  if(confirm("Clear ALL data?")){
    state = {i:0, map:{}, notes:{}};
    save();
    location.reload();
  }
};
function hideMissingAndJump(){
  $("notCheckedModal").style.display = "none";
  if(window.__firstMissingIdx >= 0) show(window.__firstMissingIdx);
}
</script>
</body>
</html>