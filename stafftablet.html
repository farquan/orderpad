<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#10b981">
    
    <title>Staff Tablet - Task Board</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- PALETTE: ROYAL BLUE THEME --- */
            --bg-gradient: linear-gradient(90deg, #5375ff 0%, #5d5bf8 100%);
            --card-bg: #1f2937; 
            --text-dark: #f3f4f6; 
            --text-light: #d1d5db; 
            
            /* Accents */
            --col-opening: #22d3ee;
            --col-day: #fbbf24;
            --col-closing: #e879f9;
            --col-multi: #a78bfa;
            
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Poppins', sans-serif; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            color: var(--text-dark); 
            background: var(--bg-gradient);
            background-attachment: fixed;
            background-size: cover;
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* HEADER */
        .header-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 25px; 
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            color: white; 
            flex-shrink: 0; 
            z-index: 20; 
            position: relative; 
        }
        
        h2 { margin: 0; font-size: 22px; font-weight: 700; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; } 
        
        .header-right { display: flex; align-items: center; gap: 10px; }
        
        #date-display { 
            font-size: 20px; font-weight: 700; color: rgba(255,255,255,0.95); 
            text-transform: uppercase; letter-spacing: 0.5px; margin-left: 10px;
        }
        
        #clock { 
            font-size: 20px; font-weight: 700; color: #ffffff; 
            font-family: 'Poppins', monospace; 
            background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);
            padding: 6px 16px; border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-left: 5px;
        }

        /* BUTTON STYLES */
        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 8px 16px; border-radius: 10px;
            font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 13px;
            cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
            transition: all 0.2s; white-space: nowrap;
        }
        .header-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-1px); }
        .header-btn:active { transform: scale(0.96); }

        .fs-btn { background: #2563eb; border-color: #60a5fa; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .fs-btn:hover { background: #1d4ed8; }
        .logs-btn { background: rgba(0,0,0,0.4); border-color: rgba(0,0,0,0.5); color: #fbbf24; }

        .edit-ticker-btn {
            background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; width: 36px; height: 36px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: background 0.2s; margin-left: 5px;
        }
        .edit-ticker-btn:hover { background: rgba(255, 255, 255, 0.4); }

        /* --- CHALKBOARD (Standard) --- */
        .chalkboard {
            width: 95%; margin: 15px auto 15px auto;
            background-color: #262626; border: 8px solid #5c4033;
            border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            padding: 15px; font-family: 'Patrick Hand', cursive;
            display: flex; flex-direction: column; gap: 8px; position: relative;
            color: #eeeeee; flex-shrink: 0;
        }
        .chalkboard::after { content: ''; position: absolute; bottom: -8px; left: -8px; right: -8px; height: 4px; background: rgba(0,0,0,0.3); }

        .chalk-urgent-row {
            border-bottom: 1px dashed rgba(255,255,255,0.3); padding-bottom: 8px;
            margin-bottom: 2px; font-size: 20px; color: #ff6b6b;
            display: flex; align-items: center; gap: 10px;
        }
        .urgent-badge {
            background: #c53030; color: white;
            font-family: 'Poppins', sans-serif; font-size: 11px; font-weight: 700;
            padding: 2px 6px; border-radius: 4px; letter-spacing: 1px;
        }
        .chalk-general-text { font-size: 22px; color: #ffffff; line-height: 1.3; white-space: pre-line; }

        /* --- MINIMIZED CHALKBOARD (Empty State) --- */
        .empty-ticker-container {
            width: 95%; margin: 10px auto; display: none; /* Hidden by default */
            justify-content: center;
        }
        .add-msg-btn {
            background: rgba(255,255,255,0.15); border: 2px dashed rgba(255,255,255,0.4);
            color: white; padding: 10px 20px; border-radius: 30px; cursor: pointer;
            font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.2s;
        }
        .add-msg-btn:hover { background: rgba(255,255,255,0.25); border-color: white; }

        /* TASK PANEL */
        #task-panel { 
            flex-grow: 1; padding: 20px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 5px; 
            background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); 
            background-size: 30px 30px; 
        }

        .section-title { 
            font-size: 14px; font-weight: 700; color: rgba(255,255,255,0.9); 
            margin: 8px 0 5px 0; display: flex; align-items: center; gap: 10px; 
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer; user-select: none;
            transition: all 0.3s ease; padding: 12px 15px; border-radius: 16px;
            background: rgba(255, 255, 255, 0.05); border: 1px solid transparent;
        }
        .section-title:active { opacity: 0.9; transform: scale(0.99); }
        .section-title span.icon-box { 
            background: rgba(0,0,0,0.2); color: white; width: 32px; height: 32px; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 10px; font-size: 18px; border: 1px solid rgba(255,255,255,0.1); 
        }

        .title-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            border: 1px solid #34d399; color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .title-red {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            border: 1px solid #f87171; color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .section-note { margin-left: auto; font-size: 11px; font-weight: 600; background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 20px; color: #e5e7eb; border: 1px solid rgba(255,255,255,0.2); }
        .toggle-arrow { margin-left: 10px; font-size: 12px; opacity: 0.8; transition: transform 0.2s; }

        .daily-row { display: flex; gap: 15px; overflow-x: auto; padding: 5px; white-space: nowrap; -webkit-overflow-scrolling: touch; min-height: 95px; scrollbar-width: none; align-items: center; transition: all 0.3s ease; }
        .daily-row::-webkit-scrollbar { display: none; }
        .locked { opacity: 0.3; filter: grayscale(100%); pointer-events: none; }
        
        /* CARDS */
        .daily-card { 
            min-width: 160px; height: 82px; background: var(--card-bg); 
            border-radius: 16px; padding: 12px; box-shadow: var(--card-shadow); 
            display: flex; flex-direction: column; justify-content: center; 
            cursor: pointer; white-space: normal; position: relative; 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); 
            border: 1px solid rgba(255,255,255,0.05); overflow: hidden; 
        }
        .daily-card:active { transform: scale(0.96); }
        .daily-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.2); }
        .daily-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        
        /* --- URGENCY LEVELS --- */
        
        /* Level 1: Due Soon (Amber) - Within 15 mins before or after due time */
        .due-soon {
            border: 2px solid #fbbf24 !important;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }
        .due-soon .due-badge {
            background: #fbbf24 !important;
            color: #1f2937 !important;
            border-color: #f59e0b !important;
        }

        /* Level 2: Overdue (Red) - 15+ mins late */
        .overdue {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%) !important;
            border: 2px solid #fee2e2 !important;
            animation: pulse-red 2s infinite;
        }
        
        /* Level 3: Very Overdue (Dark Red + Fast Pulse) - 60+ mins late */
        .very-overdue {
            background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%) !important;
            border: 2px solid #ff0000 !important;
            animation: pulse-red 0.8s infinite;
        }

        .hazard-icon {
            position: absolute;
            top: 38px; /* Positioned below time */
            right: 10px; /* Aligned to right */
            left: auto;
            font-size: 20px; /* Smaller size */
            z-index: 20;
            display: none; 
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .daily-card strong { font-size: 14px; display: block; line-height: 1.2; margin-top: 10px; margin-bottom: 2px; color: var(--text-dark); font-weight: 600; }
        .card-subtext { font-size: 10px; color: var(--text-light); margin-top: 0; font-weight: 500; }
        .due-badge { 
            position: absolute; top: 8px; right: 8px; 
            font-size: 13px; /* Bigger font */
            font-weight: 700; background: #374151; color: #e5e7eb; 
            padding: 4px 8px; border-radius: 6px; 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
        }
        
        /* Task Image - INSIDE MODAL */
        #sign-task-image {
            max-width: 100%;
            height: auto;
            max-height: 200px;
            margin: 0 auto 15px auto;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            display: none; /* Hidden by default */
            object-fit: contain;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .card-stack { overflow: visible !important; margin-right: 15px; min-width: 170px; }
        .card-stack::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); z-index: -1; transform: rotate(5deg); box-shadow: var(--card-shadow); opacity: 0.6; }
        .card-stack::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg); border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); z-index: -2; transform: rotate(10deg); box-shadow: var(--card-shadow); opacity: 0.3; }
        .stack-top-layer { position: absolute; top:0; left:0; width:100%; height:100%; background: var(--card-bg); border-radius:16px; z-index:2; padding:12px; display:flex; flex-direction:column; justify-content: center; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; }
        .stack-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--col-multi); border-top-left-radius: 16px; border-bottom-left-radius: 16px;}

        .opening-card::before { background: var(--col-opening); box-shadow: 0 0 10px var(--col-opening); }
        .day-card::before { background: var(--col-day); box-shadow: 0 0 10px var(--col-day); }
        .closing-card::before { background: var(--col-closing); box-shadow: 0 0 10px var(--col-closing); }
        .green { background: #059669 !important; color: white !important; border: 1px solid #34d399 !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .green strong { color: white; }
        .green .card-subtext { color: rgba(255,255,255,0.9); }
        
        .add-btn-inline { width: 100%; margin-top: 20px; padding: 18px; background-color: rgba(255,255,255,0.1); border: 2px dashed #ffffff; border-radius: 16px; color: #ffffff; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
        .add-btn-inline:active { background: rgba(255, 255, 255, 0.2); transform: scale(0.98); }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); z-index: 200; align-items: center; justify-content: center; }
        .modal-box { background: #1f2937; padding: 30px; border-radius: 24px; width: 340px; text-align: center; border: 1px solid #374151; box-shadow: 0 20px 40px rgba(0,0,0,0.4); color: white; }
        
        .save-btn { flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .cancel-btn { flex: 1; padding: 14px; background: #374151; color: #d1d5db; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;}
        
        /* FACE ID BUTTON STYLE */
        .bio-btn {
            width: 100%; padding: 14px; margin-bottom: 20px;
            background: #6366f1; color: white; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s;
        }
        .bio-btn:active { transform: scale(0.98); background: #4f46e5; }
        
        input, select, textarea { width: 100%; padding: 15px; margin-bottom: 20px; background: #111827; border: 2px solid #374151; border-radius: 12px; font-family: 'Poppins', sans-serif; color: white; outline: none; transition: border-color 0.2s; resize: none; }
        input:focus, select:focus, textarea:focus { border-color: #6366f1; }
        .hidden { display: none !important; }
        .form-label { text-align: left; display: block; margin-bottom: 5px; font-size: 12px; color: #94a3b8; }

        .till-btn { flex: 1; padding: 12px; background: #374151; border: 2px solid transparent; border-radius: 10px; color: #9ca3af; cursor: pointer; font-weight: 600; font-family: 'Poppins', sans-serif; transition: all 0.2s; }
        .till-btn:hover { background: #4b5563; }
        .till-btn.active { background: #2563eb; color: white; border-color: #60a5fa; box-shadow: 0 0 10px rgba(37, 99, 235, 0.4); }

        .log-table-container { max-height: 400px; overflow-y: auto; text-align: left; margin-top: 10px; border: 1px solid #374151; border-radius: 10px; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 12px; color: #d1d5db; }
        .log-table th { background: #374151; padding: 10px; position: sticky; top: 0; text-align: left; color: white; }
        .log-table td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-table tr:hover { background: rgba(255,255,255,0.05); }
        .tab-btn { background: #374151; color: #9ca3af; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; margin-right: 5px; }
        .tab-btn.active { background: #2563eb; color: white; }

        .preset-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .preset-btn { background: #374151; border: 1px solid rgba(255,255,255,0.05); color: #d1d5db; padding: 10px 5px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; font-family: 'Poppins', sans-serif; transition: all 0.2s; }
        .preset-btn:hover { background: #4b5563; color: white; border-color: rgba(255,255,255,0.2); }
        .preset-btn:active { transform: scale(0.95); }

        .supplier-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .supplier-btn { background: #374151; border: 2px solid transparent; color: #f3f4f6; padding: 15px; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: 600; text-align: center; transition: all 0.2s; }
        .supplier-btn:hover { background: #4b5563; }
        .supplier-btn.active { background: #2563eb; border-color: #60a5fa; color: white; box-shadow: 0 0 10px rgba(37, 99, 235, 0.4); }
    </style>
</head>
<body>

    <div class="header-bar">
        <h2>‚ú® Staff Board</h2>
        <div class="header-right">
            <button class="header-btn fs-btn" onclick="toggleFullScreen()">üñ•Ô∏è Full Screen</button>
            <button class="header-btn" onclick="playSound('click'); alert('Lunch & Break Rota coming soon!')">ü•™ Lunch Rota</button>
            <button class="header-btn" onclick="playSound('click'); openPayoutModal()">üí∏ Pay Outs</button>
            <button class="header-btn" onclick="playSound('click'); openSafeDropModal()">üîí Safe Drops</button>
            <button class="header-btn logs-btn" onclick="playSound('click'); openPinModal()">üìã View Logs</button>
            <button class="edit-ticker-btn" onclick="playSound('click'); openEditTickerModal()">‚öôÔ∏è</button>
            <div id="date-display">Mon 01 Jan</div>
            <div id="clock">00:00</div>
        </div>
    </div>

    <div id="main-chalkboard" class="chalkboard">
        <div id="urgent-row" class="chalk-urgent-row">
            <span class="urgent-badge">URGENT</span>
            <span id="ticker-urgent-text">Loading...</span>
        </div>
        <div id="general-row">
            <div id="ticker-general-text" class="chalk-general-text">Loading...</div>
        </div>
    </div>

    <div id="empty-ticker-btn" class="empty-ticker-container">
        <div class="add-msg-btn" onclick="openEditTickerModal()">
            <span>‚ûï</span> Add Message
        </div>
    </div>
    
    <div id="task-panel">
        <div class="section-title" id="openingTitle" onclick="playSound('click'); manualToggle('openingList', 'openingArrow')">
            <span class="icon-box">üåÖ</span> Opening Duties <span id="openingArrow" class="toggle-arrow">‚ñº</span>
        </div>
        <div class="daily-row" id="openingList"></div>
        
        <div class="section-title"><span class="icon-box">‚è∞</span> Repeatable Prep</div>
        <div class="daily-row" id="multiList"></div>

        <div class="section-title"><span class="icon-box">‚òÄÔ∏è</span> Day Duties</div>
        <div class="daily-row" id="dayList"></div>

        <div class="section-title" id="closingTitle" onclick="playSound('click'); manualToggle('closingList', 'closingArrow')">
            <span class="icon-box">üåô</span> Closing Duties <span class="section-note">(Unlocks 20:00)</span> <span id="closingArrow" class="toggle-arrow">‚ñº</span>
        </div>
        <div class="daily-row" id="closingList"></div>

        <button class="add-btn-inline" onclick="playSound('click'); openAddModal()">‚ûï Add New Task</button>
    </div>

    <div id="sign-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Sign Off</h3>
            <img id="sign-task-image" src="" alt="Task Image">
            
            <p id="signOffPrompt" style="color:#94a3b8; margin-bottom:20px;"></p>
            
            <button class="bio-btn" onclick="useBiometrics()">
                <span style="font-size: 20px;">üë§</span> Use Face ID
            </button>
            
            <p style="font-size: 11px; color: #6b7280; margin-bottom: 10px;">‚Äî OR ENTER INITIALS ‚Äî</p>

            <input type="text" id="initials" maxlength="3" style="text-align:center; font-size:24px; text-transform:uppercase;" placeholder="ABC">
            <div style="display:flex;gap:15px;">
                <button class="cancel-btn" onclick="playSound('click'); closeModal('sign-modal')">Back</button>
                <button class="save-btn" onclick="confirmComplete()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="add-task-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>‚ûï Add New Task</h3>
            
            <label class="form-label">Task Name</label>
            <input type="text" id="new-task-name" placeholder="e.g. Sweep Floors">
            
            <label class="form-label">Due Time</label>
            <input type="time" id="new-task-time" style="text-align:center;">

            <label class="form-label">Quick Presets</label>
            <div class="preset-grid" style="grid-template-columns: repeat(3, 1fr);">
                <button class="preset-btn" onclick="fillTask('Sweep Floors')">üßπ Sweep</button>
                <button class="preset-btn" onclick="fillTask('Check Dates')">üìÖ Dates</button>
                <button class="preset-btn" onclick="fillTask('Restock Drinks')">ü•§ Drinks</button>
                <button class="preset-btn" onclick="fillTask('Wipe Counters')">üßΩ Wipe</button>
                <button class="preset-btn" onclick="fillTask('Empty Bins')">üóëÔ∏è Bins</button>
                <button class="preset-btn" onclick="fillTask('Mop Floor')">üßº Mop</button>
            </div>

            <div style="display:flex;gap:15px; margin-top:20px;">
                <button class="cancel-btn" onclick="closeModal('add-task-modal')">Cancel</button>
                <button class="save-btn" onclick="saveNewTask()">Add Task</button>
            </div>
        </div>
    </div>

    <div id="payout-modal" class="modal-overlay">
        <div class="modal-box" style="width: 450px;"> 
            <h3>üí∏ Pay Out</h3>
            <label class="form-label">Select Supplier</label>
            <div class="supplier-grid">
                <div class="supplier-btn" onclick="playSound('click'); selectSupplier(this, 'Coca Cola')">Coca Cola</div>
                <div class="supplier-btn" onclick="playSound('click'); selectSupplier(this, 'Walkers')">Walkers</div>
                <div class="supplier-btn" onclick="playSound('click'); selectSupplier(this, 'Bakery')">Bakery</div>
                <div class="supplier-btn" onclick="playSound('click'); selectSupplier(this, 'Milkman')">Milkman</div>
                <div class="supplier-btn" onclick="playSound('click'); selectSupplier(this, 'Window Cleaner')">Window Cleaner</div>
                <div class="supplier-btn" onclick="playSound('click'); selectSupplier(this, 'Other')">Other</div>
            </div>
            <input type="hidden" id="payout-supplier">
            <label class="form-label">Amount (¬£)</label>
            <input type="number" id="payout-amount" placeholder="0.00" step="0.01" style="margin-bottom: 10px;">
            <div class="preset-grid">
                <button class="preset-btn" onclick="playSound('click'); setPayoutAmount(100)">¬£100</button>
                <button class="preset-btn" onclick="playSound('click'); setPayoutAmount(200)">¬£200</button>
                <button class="preset-btn" onclick="playSound('click'); setPayoutAmount(300)">¬£300</button>
                <button class="preset-btn" onclick="playSound('click'); setPayoutAmount(400)">¬£400</button>
                <button class="preset-btn" onclick="playSound('click'); setPayoutAmount(500)">¬£500</button>
            </div>
            <label class="form-label">Paid From</label>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button id="po-till-1" class="till-btn" onclick="playSound('click'); selectTill('po', 1)">Till 1</button>
                <button id="po-till-2" class="till-btn" onclick="playSound('click'); selectTill('po', 2)">Till 2</button>
            </div>
            <div style="display:flex;gap:15px;">
                <button class="cancel-btn" onclick="playSound('click'); closeModal('payout-modal')">Cancel</button>
                <button class="save-btn" onclick="savePayout()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="safedrop-modal" class="modal-overlay">
        <div class="modal-box" style="width: 400px;"> 
            <h3>üîí Safe Drop</h3>
            <label class="form-label">Amount Dropped (¬£)</label>
            <input type="number" id="sd-amount" placeholder="0.00" step="0.01" style="margin-bottom: 20px; font-size:24px; text-align:center;">
            
            <label class="form-label">Dropped From</label>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button id="sd-till-1" class="till-btn" onclick="playSound('click'); selectTill('sd', 1)">Till 1</button>
                <button id="sd-till-2" class="till-btn" onclick="playSound('click'); selectTill('sd', 2)">Till 2</button>
            </div>
            
            <label class="form-label">Witness Initials</label>
            <input type="text" id="sd-witness" maxlength="3" style="text-align:center; text-transform:uppercase;" placeholder="Witness">
            <div style="display:flex;gap:15px;">
                <button class="cancel-btn" onclick="playSound('click'); closeModal('safedrop-modal')">Cancel</button>
                <button class="save-btn" onclick="saveSafeDrop()">Confirm Drop</button>
            </div>
        </div>
    </div>

    <div id="pin-modal" class="modal-overlay">
        <div class="modal-box" style="width: 300px;">
            <h3>üîê Enter PIN</h3>
            <input type="password" id="pin-input" maxlength="4" style="text-align:center; font-size:32px; letter-spacing:10px;" placeholder="****">
            <div style="display:flex;gap:15px;">
                <button class="cancel-btn" onclick="closeModal('pin-modal')">Cancel</button>
                <button class="save-btn" onclick="verifyPin()">Unlock</button>
            </div>
        </div>
    </div>

    <div id="logs-modal" class="modal-overlay">
        <div class="modal-box" style="width: 600px; max-width:90%;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>üìã Daily Logs</h3>
                <button class="cancel-btn" style="flex:0; padding:5px 10px;" onclick="closeModal('logs-modal')">‚úñ</button>
            </div>
            <div style="display:flex; margin-bottom:10px;">
                <button class="tab-btn active" onclick="switchLogTab(this, 'tasks')">Tasks</button>
                <button class="tab-btn" onclick="switchLogTab(this, 'safedrops')">Safe Drops</button>
                <button class="tab-btn" onclick="switchLogTab(this, 'payouts')">Pay Outs</button>
            </div>
            <div class="log-table-container">
                <table class="log-table" id="log-table-body"></table>
            </div>
        </div>
    </div>

    <div id="edit-ticker-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Edit Chalkboard</h3>
            <label class="form-label">Urgent Alert (Red)</label>
            <input type="text" id="input-urgent">
            <label class="form-label">General Messages (White)</label>
            <textarea id="input-general" rows="5"></textarea>
            <div style="display:flex;gap:15px;">
                <button class="cancel-btn" onclick="closeModal('edit-ticker-modal')">Cancel</button>
                <button class="save-btn" onclick="saveTicker()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETTINGS ---
        const MESSAGE_LIFETIME_HOURS = 48; // Messages expire after 48 hours
        
        // GLOBAL VARIABLE TO TRACK DATE CHANGES
        let lastCheckedDate = new Date().getDate();
        
        // UNDO CALLBACK
        let onPinSuccess = null;

        // --- TELEGRAM CONFIG ---
        // Replace these with your actual details!
        const TELEGRAM_BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"; 
        const TELEGRAM_CHAT_ID = "YOUR_CHAT_ID_HERE";

        function sendTelegramAlert(message) {
            if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID || TELEGRAM_BOT_TOKEN.includes("YOUR_")) {
                console.log("Telegram Token not set. Message not sent:", message);
                return;
            }
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            const data = { chat_id: TELEGRAM_CHAT_ID, text: message };
            
            fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).catch(err => console.error("Telegram Error:", err));
        }

        // --- 2. FACE ID / BIOMETRIC LOGIC ---
        async function useBiometrics() {
            // Check if browser supports WebAuthn (Must be HTTPS)
            if (!window.PublicKeyCredential) {
                alert("Face ID not supported or site is not HTTPS.");
                return;
            }
            
            try {
                // This 'create' call triggers the Android System verification (Face/Fingerprint/PIN)
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);
                
                await navigator.credentials.create({
                    publicKey: {
                        challenge: challenge,
                        rp: { name: "Staff Tablet" },
                        user: {
                            id: new Uint8Array(16),
                            name: "StaffUser",
                            displayName: "Staff Member"
                        },
                        pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                        authenticatorSelection: {
                            authenticatorAttachment: "platform", // Forces on-device FaceID/Fingerprint
                            // CHANGE HERE: 'preferred' tries biometrics but doesn't FORCE fallback to PIN if it fails instantly
                            userVerification: "preferred" 
                        },
                        timeout: 60000
                    }
                });

                // If code reaches here, authentication passed
                playSound('success');
                document.getElementById('initials').value = "BIO"; // Auto-fill
                confirmComplete(); // Auto-submit
                
            } catch (err) {
                console.error(err);
                playSound('error');
                if (err.name !== 'NotAllowedError') {
                    alert("Face ID failed. Please try again or use initials.");
                }
            }
        }

        // --- 3. TICKER / BLACKBOARD AUTO-EXPIRY & MINIMIZE ---
        function saveTicker() {
            const u = document.getElementById('input-urgent').value.trim();
            const g = document.getElementById('input-general').value.trim();
            
            // Save data with a Timestamp
            const data = {
                urgent: u,
                general: g,
                timestamp: Date.now()
            };
            
            localStorage.setItem('tickerData', JSON.stringify(data));
            playSound('success');
            closeModal('edit-ticker-modal');
            loadSavedTicker(); // Refresh UI immediately
        }

        function loadSavedTicker() {
            const savedRaw = localStorage.getItem('tickerData');
            
            if (savedRaw) {
                const data = JSON.parse(savedRaw);
                const ageMs = Date.now() - data.timestamp;
                const limitMs = MESSAGE_LIFETIME_HOURS * 60 * 60 * 1000;

                // Check Expiry
                if (ageMs > limitMs) {
                    // Expired! Clear it.
                    localStorage.removeItem('tickerData');
                    renderTicker("", ""); 
                } else {
                    // Valid
                    renderTicker(data.urgent, data.general);
                }
            } else {
                renderTicker("", "");
            }
        }

        function renderTicker(urgent, general) {
            const board = document.getElementById('main-chalkboard');
            const emptyBtn = document.getElementById('empty-ticker-btn');
            
            // If both are empty, minimize
            if (!urgent && !general) {
                board.style.display = 'none';
                emptyBtn.style.display = 'flex';
            } else {
                board.style.display = 'flex';
                emptyBtn.style.display = 'none';
                
                // Toggle Urgent Row
                const uRow = document.getElementById('urgent-row');
                if (urgent) {
                    uRow.style.display = 'flex';
                    document.getElementById('ticker-urgent-text').innerText = urgent;
                } else {
                    uRow.style.display = 'none';
                }

                // Toggle General Row
                const gRow = document.getElementById('general-row');
                if (general) {
                    gRow.style.display = 'block';
                    document.getElementById('ticker-general-text').innerText = general;
                } else {
                    gRow.style.display = 'none';
                }
            }
        }
        
        function openEditTickerModal() {
            const savedRaw = localStorage.getItem('tickerData');
            if (savedRaw) {
                const data = JSON.parse(savedRaw);
                document.getElementById('input-urgent').value = data.urgent;
                document.getElementById('input-general').value = data.general;
            } else {
                document.getElementById('input-urgent').value = "";
                document.getElementById('input-general').value = "";
            }
            document.getElementById('edit-ticker-modal').style.display = 'flex';
        }

        // --- 4. FULL SCREEN & SOUND ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            if (type === 'click') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); 
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            } else if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(523, audioCtx.currentTime); osc.frequency.setValueAtTime(659, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            } else if (type === 'error') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        // --- 5. LOGGING & DATA ---
        function addToLog(type, details) {
            const now = new Date();
            const entry = {
                type: type,
                time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                date: now.toLocaleDateString(),
                details: details
            };
            let logs = JSON.parse(localStorage.getItem('staffLogs')) || [];
            logs.unshift(entry);
            
            // Limit to last 150 entries to prevent infinite growth
            if (logs.length > 150) {
                logs = logs.slice(0, 150);
            }
            
            localStorage.setItem('staffLogs', JSON.stringify(logs));
        }

        function openPinModal(callback) {
            if(typeof callback === 'function') {
                onPinSuccess = callback;
            } else {
                onPinSuccess = null; // Default view mode
            }
            document.getElementById('pin-modal').style.display = 'flex';
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-input').focus();
        }

        function verifyPin() {
            if (document.getElementById('pin-input').value === "1234") {
                closeModal('pin-modal');
                if (onPinSuccess) {
                    onPinSuccess(); // Execute Undo
                    onPinSuccess = null;
                } else {
                    openLogsModal(); // Default View Logs
                }
            } else {
                playSound('error');
                alert("Incorrect PIN");
            }
        }

        function openLogsModal() {
            document.getElementById('logs-modal').style.display = 'flex';
            renderLogs('tasks');
        }

        function switchLogTab(btn, type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderLogs(type);
        }

        function renderLogs(filterType) {
            const logs = JSON.parse(localStorage.getItem('staffLogs')) || [];
            const table = document.getElementById('log-table-body');
            table.innerHTML = "";
            let headers = "";
            if (filterType === 'tasks') headers = "<tr><th>Time</th><th>Task Name</th><th>Action</th></tr>";
            if (filterType === 'safedrops') headers = "<tr><th>Time</th><th>Amount</th><th>Till</th><th>Witness</th></tr>";
            if (filterType === 'payouts') headers = "<tr><th>Time</th><th>Amount</th><th>Supplier</th><th>Till</th></tr>";
            table.innerHTML = headers;

            const filtered = logs.filter(l => {
                if(filterType === 'tasks') return l.type === 'TASK_COMPLETE' || l.type === 'TASK_UNDO';
                if(filterType === 'safedrops') return l.type === 'SAFE_DROP';
                if(filterType === 'payouts') return l.type === 'PAYOUT';
                return false;
            });

            if (filtered.length === 0) {
                table.innerHTML += "<tr><td colspan='4' style='text-align:center; padding:20px; color:#6b7280;'>No logs found for this category.</td></tr>";
                return;
            }

            filtered.forEach(log => {
                let row = `<tr><td>${log.date} ${log.time}</td>`;
                if (filterType === 'tasks') {
                    if (log.type === 'TASK_UNDO') {
                        row += `<td>${log.details.task}</td><td style="color:#ef4444; font-weight:bold;">UNDO</td>`;
                    } else {
                        row += `<td>${log.details.task}</td><td>${log.details.staff}</td>`;
                    }
                } else if (filterType === 'safedrops') {
                    row += `<td>¬£${log.details.amount}</td><td>Till ${log.details.till}</td><td>${log.details.witness}</td>`;
                } else if (filterType === 'payouts') {
                    row += `<td>¬£${log.details.amount}</td><td>${log.details.supplier}</td><td>Till ${log.details.till}</td>`;
                }
                row += "</tr>";
                table.innerHTML += row;
            });
        }

        // --- 6. PAYOUT & SAFE DROP LOGIC ---
        let selectedTillSD = 1;
        let selectedTillPO = 1;
        
        function openSafeDropModal() {
            document.getElementById('safedrop-modal').style.display = 'flex';
            document.getElementById('sd-amount').value = '';
            document.getElementById('sd-witness').value = '';
            selectTill('sd', 1);
        }
        function saveSafeDrop() {
            const amt = document.getElementById('sd-amount').value;
            const wit = document.getElementById('sd-witness').value.toUpperCase();
            if(!amt || !wit) { playSound('error'); return alert("Fill all fields"); }
            addToLog('SAFE_DROP', { amount: amt, till: selectedTillSD, witness: wit });
            playSound('success');
            
            // Telegram Alert for Safe Drop
            sendTelegramAlert(`üîí SAFE DROP: ¬£${amt} from Till ${selectedTillSD} by ${wit}`);
            
            alert(`‚úÖ Safe Drop Recorded: ¬£${amt}`);
            closeModal('safedrop-modal');
        }

        function openPayoutModal() {
            document.getElementById('payout-modal').style.display = 'flex';
            document.getElementById('payout-amount').value = ''; 
            selectTill('po', 1); 
            document.querySelectorAll('.supplier-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('payout-supplier').value = '';
        }
        function setPayoutAmount(amount) { document.getElementById('payout-amount').value = amount; }
        function selectSupplier(el, name) {
            document.querySelectorAll('.supplier-btn').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('payout-supplier').value = name;
        }
        function selectTill(context, num) {
            if(context === 'po') {
                selectedTillPO = num;
                document.getElementById('po-till-1').className = num === 1 ? 'till-btn active' : 'till-btn';
                document.getElementById('po-till-2').className = num === 2 ? 'till-btn active' : 'till-btn';
            } else {
                selectedTillSD = num;
                document.getElementById('sd-till-1').className = num === 1 ? 'till-btn active' : 'till-btn';
                document.getElementById('sd-till-2').className = num === 2 ? 'till-btn active' : 'till-btn';
            }
        }
        function savePayout() {
            const supp = document.getElementById('payout-supplier').value;
            const amt = document.getElementById('payout-amount').value;
            if(!supp || !amt) { playSound('error'); return alert("Missing info"); }
            addToLog('PAYOUT', { amount: amt, supplier: supp, till: selectedTillPO });
            playSound('success'); 
            alert(`‚úÖ Payout Recorded: ¬£${amt}`);
            closeModal('payout-modal');
        }

        // --- 7. TASKS & CLOCK ---
        function manualToggle(listId, arrowId) {
            const list = document.getElementById(listId);
            const arrow = document.getElementById(arrowId);
            if (list.classList.contains('hidden')) { list.classList.remove('hidden'); arrow.innerText = '‚ñº'; }
            else { list.classList.add('hidden'); arrow.innerText = '‚óÄ'; }
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // --- NEW TASK MODAL LOGIC ---
        function openAddModal() { 
            document.getElementById('add-task-modal').style.display = 'flex';
            
            // Set default time to current time + 1 hour
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('new-task-time').value = timeStr;
            document.getElementById('new-task-name').value = '';
            document.getElementById('new-task-name').focus();
        }

        function fillTask(name) {
            document.getElementById('new-task-name').value = name;
        }

        function saveNewTask() {
            const name = document.getElementById('new-task-name').value.trim();
            const time = document.getElementById('new-task-time').value;

            if (!name || !time) {
                playSound('error');
                alert("Please enter a name and time!");
                return;
            }

            const newTask = {
                name: name,
                time: time,
                img: null 
            };

            // Add to the dayTasks array
            dayTasks.push(newTask);
            
            // Save to LocalStorage for persistence
            let custom = JSON.parse(localStorage.getItem('customTasks') || '[]');
            custom.push(newTask);
            localStorage.setItem('customTasks', JSON.stringify(custom));

            // Refresh the view
            populateList('dayList', dayTasks, 'day-card');
            
            playSound('success');
            closeModal('add-task-modal');
        }

        // --- 8. STATE PERSISTENCE & DAILY RESET ---
        let appState = {
            date: new Date().toLocaleDateString(),
            completedTasks: {}, // Map of "Task Name" -> "INITIALS"
            stackCounts: []     // Array of integers
        };

        // Helper to generate the default day tasks dynamically
        function getDefaultDayTasks() {
            let tasks = [
                { name: "Bins Emptied", time: "14:00" },
                { name: "Face Up (Pull to Front)", time: "16:00", img: "faceup.jpg" }
            ];
            
            // Weekday logic
            const dayOfWeek = new Date().getDay();
            if (dayOfWeek === 0 || dayOfWeek === 3 || dayOfWeek === 5) {
                tasks.push({
                    name: "Stock Check (Pitta/Naan)",
                    time: "17:00",
                    img: "naan.jpg"
                });
            }
            return tasks;
        }

        // This function wipes data when a new day is detected
        function resetDailyData() {
            console.log("New Day Detected! Resetting Board...");
            
            // 1. Reset Storage State
            appState = {
                date: new Date().toLocaleDateString(),
                completedTasks: {},
                stackCounts: new Array(repeatableStacks.length).fill(0)
            };
            saveState();

            // 2. Reset In-Memory Stacks
            repeatableStacks.forEach(s => s.current = 0);

            // 3. Clear Daily Logs (Start fresh for the day)
            localStorage.removeItem('staffLogs');

            // 4. Clear Custom Tasks (Start fresh for the day)
            localStorage.removeItem('customTasks');

            // 5. Reset In-Memory Day Tasks to defaults
            dayTasks = getDefaultDayTasks();
        }

        function loadState() {
            const raw = localStorage.getItem('dailyTaskState');
            const today = new Date().toLocaleDateString();
            
            if (raw) {
                const data = JSON.parse(raw);
                // Check if the saved state is from today
                if (data.date === today) {
                    appState = data;
                    // Sync stack counts from storage
                    if (appState.stackCounts && appState.stackCounts.length === repeatableStacks.length) {
                         repeatableStacks.forEach((s, i) => s.current = appState.stackCounts[i]);
                    }
                } else {
                    // It's a new day (state is old) -> WIPE EVERYTHING
                    resetDailyData();
                }
            } else {
                // First time ever running -> Initialize
                resetDailyData();
            }
        }

        function saveState() {
            localStorage.setItem('dailyTaskState', JSON.stringify(appState));
        }

        const openingTasks = [{name:"Temp Check",time:"10:00"},{name:"Milk/Eggs Stock",time:"10:30"}];
        
        let repeatableStacks = [
            {
                name: "Check Fruit/Veg",
                times: ["11:00", "15:00", "19:00"],
                current: 0,
                img: null
            },
            {
                name: "Fill Milk Fridge",
                times: ["10:30", "14:30", "18:30"],
                current: 0,
                img: "milk.jpg"
            },
            {
                name: "Refill Eggs",
                times: ["10:00", "14:00", "18:00"],
                current: 0,
                img: "eggs.jpg"
            },
            {
                name: "Refill Onions & Potatoes",
                times: ["11:00", "15:00", "19:00"],
                current: 0,
                img: "onions.jpg"
            },
       ];

        let dayTasks = []; // Will be populated by onload

        const closingTasks = [{name:"Phone Charge",time:"20:30"},{name:"Freezers Closed",time:"20:30"},{name:"Zettle Charged",time:"20:30"},{name:"Bags Stacked",time:"20:30"},{name:"Till Roll",time:"20:30"},{name:"Bins",time:"20:30"},{name:"Onions/Potatoes",time:"20:45"},{name:"HAACP",time:"21:00"},{name:"Final Temps",time:"21:00"},{name:"Side Door",time:"21:15"}];

        window.onload = function() {
            // 1. Initialize Standard Tasks first
            dayTasks = getDefaultDayTasks();

            // 2. Load State (Checks for date mismatch)
            // If date changed, this function calls resetDailyData() which wipes customTasks storage
            loadState(); 

            // 3. Load Custom Tasks (Only if they still exist after step 2)
            const savedCustom = JSON.parse(localStorage.getItem('customTasks') || '[]');
            if (savedCustom.length > 0) {
                dayTasks = dayTasks.concat(savedCustom);
            }

            populateList('openingList', openingTasks, 'opening-card');
            renderRepeatableSection(); 
            populateList('dayList', dayTasks, 'day-card');
            populateList('closingList', closingTasks, 'closing-card');
            updateClock(); 
            loadSavedTicker(); 
            updateAllSections();
        };

        // --- NEW HELPER FOR LONG PRESS ---
        function addLongPressListener(el, callback) {
            let timer;
            let longPressTriggered = false;

            function start() {
                longPressTriggered = false;
                timer = setTimeout(() => {
                    longPressTriggered = true;
                    if(navigator.vibrate) navigator.vibrate(50);
                    callback(); 
                }, 800); // 800ms Hold Time
            }

            function end() {
                clearTimeout(timer);
            }

            el.addEventListener('mousedown', start);
            el.addEventListener('touchstart', start, {passive: true});
            el.addEventListener('mouseup', end);
            el.addEventListener('mouseleave', end);
            el.addEventListener('touchend', end);
            el.addEventListener('touchmove', end);
            
            // Prevent context menu
            el.oncontextmenu = function(e) {
                e.preventDefault();
                return false;
            };
            
            return () => longPressTriggered; // Returns checker
        }

        function populateList(cid, tasks, cls) {
            const c = document.getElementById(cid); c.innerHTML = ""; 
            tasks.forEach(t => {
                let d = document.createElement('div'); 
                
                // CHECK IF COMPLETED IN SAVED STATE
                const completionInfo = appState.completedTasks[t.name];
                
                if (completionInfo) {
                    d.className = `daily-card ${cls} green`;
                    d.innerHTML = `
                        <span class="due-badge">${t.time}</span>
                        <strong>‚úÖ ${t.name}</strong>
                        <div class="card-subtext">By ${completionInfo}</div>`;
                    
                    // Add Long Press Undo for Completed Items
                    addLongPressListener(d, () => performUndo(t.name, -1));
                    
                } else {
                    d.className = `daily-card ${cls}`;
                    d.onclick = function() { playSound('click'); openSignOff(this, t.name, -1, t.img); };
                    d.innerHTML = `
                        <span class="due-badge">${t.time}</span>
                        <strong>${t.name}</strong>
                        <div class="card-subtext">Tap to complete</div>`;
                }
                c.appendChild(d);
            });
        }

        // New function to handle multiple repeatable stacks
        function renderRepeatableSection() {
            const c = document.getElementById('multiList'); 
            c.innerHTML = ""; 

            repeatableStacks.forEach((stack, index) => {
                let d = document.createElement('div');
                
                // Add Long Press Listener for UNDO on Stacks
                // We use a small closure to handle the click vs long-press conflict
                const checkLongPress = addLongPressListener(d, () => performUndo(stack.name, index));

                if(stack.current >= stack.times.length) {
                    // All instances done
                    d.className = "daily-card green"; 
                    d.innerHTML = `<strong>‚úÖ ${stack.name}</strong><div class="card-subtext">All checks complete</div>`;
                } else {
                    // Next instance active
                    d.className = "daily-card card-stack";
                    let nt = stack.times[stack.current];
                    
                    d.innerHTML = `
                        <div class="stack-top-layer">
                            <div class="stack-bar"></div>
                            <span class="due-badge">${nt}</span>
                            <strong>${stack.name}</strong>
                            <div class="card-subtext">Tap to sign off (${stack.current + 1}/${stack.times.length})</div>
                        </div>`;
                    
                    d.onclick = function() { 
                        if (checkLongPress()) return; // Stop click if long press happened
                        playSound('click'); 
                        openSignOff(this, `${stack.name} (${nt})`, index, stack.img); 
                    };
                }
                c.appendChild(d);
            });
        }

        // --- UNDO LOGIC ---
        function performUndo(name, stackIndex) {
            openPinModal(() => {
                if (stackIndex >= 0) {
                    // Undo Stack (Decrement)
                    if (repeatableStacks[stackIndex].current > 0) {
                        repeatableStacks[stackIndex].current--;
                        appState.stackCounts[stackIndex] = repeatableStacks[stackIndex].current;
                        saveState();
                        renderRepeatableSection();
                        addToLog('TASK_UNDO', { task: name, details: "Stack Decrement" });
                        alert(`Rewound: ${name}`);
                    }
                } else {
                    // Undo Single Task (Un-complete)
                    if (appState.completedTasks[name]) {
                        delete appState.completedTasks[name];
                        saveState();
                        
                        // Brute-force re-render lists
                        populateList('openingList', openingTasks, 'opening-card');
                        populateList('dayList', dayTasks, 'day-card');
                        populateList('closingList', closingTasks, 'closing-card');
                        updateAllSections();
                        
                        addToLog('TASK_UNDO', { task: name, details: "Marked Incomplete" });
                        playSound('success');
                    }
                }
            });
        }

        let autoClosedOpening = false;
        function updateClock() {
            const now = new Date();
            const todayStr = now.toLocaleDateString();

            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
            document.getElementById('date-display').innerText = now.toLocaleDateString('en-GB', {weekday:'short',day:'numeric',month:'short'});
            
            // --- SMART MIDNIGHT RESET LOGIC ---
            // If the date in memory is different from today, reset the board without reloading
            if (todayStr !== appState.date) {
                resetDailyData(); // Clears logs, ticks, custom tasks
                
                // Re-render everything with the fresh clean state
                populateList('openingList', openingTasks, 'opening-card');
                renderRepeatableSection(); 
                populateList('dayList', dayTasks, 'day-card');
                populateList('closingList', closingTasks, 'closing-card');
                updateAllSections();
            }

            // Periodically check Blackboard expiry
            loadSavedTicker();

            // Run Overdue Logic
            checkOverdue();

            const mins = (now.getHours()*60)+now.getMinutes();
            if (now.getHours() >= 10 && !autoClosedOpening) {
                const oList = document.getElementById('openingList');
                if (oList && !oList.classList.contains('hidden')) manualToggle('openingList', 'openingArrow');
                autoClosedOpening = true; 
            }
            const locked = mins < 1200; // 20:00
            document.getElementById('closingList').classList.toggle('locked', locked);
            updateAllSections(); 
            // UPDATED INTERVAL AS REQUESTED (5 mins)
            setTimeout(updateClock, 300000); 
        }

        // --- NEW TRAFFIC LIGHT OVERDUE LOGIC ---
        function checkOverdue() {
            const now = new Date();
            const currentMins = (now.getHours() * 60) + now.getMinutes();

            document.querySelectorAll('.daily-card').forEach(card => {
                // Skip if already completed
                if (card.classList.contains('green')) return;

                const badge = card.querySelector('.due-badge');
                if (badge) {
                    const timeStr = badge.innerText.trim(); // e.g., "14:00"
                    const [h, m] = timeStr.split(':').map(Number);
                    const taskMins = (h * 60) + m;
                    const diff = currentMins - taskMins; // Positive = late, Negative = early

                    // Create icon if missing
                    let icon = card.querySelector('.hazard-icon');
                    if (!icon) {
                        icon = document.createElement('div');
                        icon.className = 'hazard-icon';
                        card.appendChild(icon);
                    }

                    // Reset all states first
                    card.classList.remove('due-soon', 'overdue', 'very-overdue');
                    icon.style.display = 'none';

                    // --- TRAFFIC LIGHT LOGIC ---
                    if (diff >= 60) {
                        // Level 3: Very Overdue (60+ mins late) -> Dark Red + Fire
                        card.classList.add('very-overdue');
                        icon.innerHTML = 'üî•';
                        icon.style.display = 'block';
                    } 
                    else if (diff >= 15) {
                        // Level 2: Overdue (15+ mins late) -> Red + Warning
                        card.classList.add('overdue');
                        icon.innerHTML = '‚ö†Ô∏è';
                        icon.style.display = 'block';
                    } 
                    else if (diff >= -15) {
                        // Level 1: Due Soon / Grace Period (15 mins before <-> 15 mins after) -> Amber + Clock
                        // This catches everything from 13:45 to 14:15 for a 14:00 task
                        card.classList.add('due-soon');
                        icon.innerHTML = '‚è∞';
                        icon.style.display = 'block';
                    }
                }
            });
        }

        function updateAllSections() {
            updateSectionStatus('openingList', 'openingTitle', 'openingArrow');
            updateSectionStatus('closingList', 'closingTitle', 'closingArrow');
        }

        function updateSectionStatus(listId, titleId, arrowId) {
            const list = document.getElementById(listId);
            const title = document.getElementById(titleId);
            const arrow = document.getElementById(arrowId);
            if(!list || !title) return;
            const total = list.children.length;
            const completed = list.querySelectorAll('.green').length;
            title.classList.remove('title-green', 'title-red');
            if (total > 0) {
                if (completed === total) {
                    title.classList.add('title-green');
                    if (!list.classList.contains('hidden')) manualToggle(listId, arrowId); 
                } else {
                    if (listId !== 'closingList' || new Date().getHours() >= 20) title.classList.add('title-red');
                }
            }
        }

        let activeCard, activeTaskName, activeStackIndex;
        
        // UPDATED FUNCTION: Now accepts imgSrc
        function openSignOff(card, name, stackIndex, imgSrc = null) {
            activeCard = card; 
            activeTaskName = name; 
            activeStackIndex = stackIndex; // -1 if not stack
            
            document.getElementById('signOffPrompt').innerText = `Sign off: ${name}`;
            
            // HANDLE IMAGE LOGIC
            const imgEl = document.getElementById('sign-task-image');
            if (imgSrc) {
                imgEl.src = imgSrc;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }

            document.getElementById('initials').value = "";
            document.getElementById('sign-modal').style.display = 'flex';
            document.getElementById('initials').focus();
        }

        function confirmComplete() {
            let init = document.getElementById('initials').value.toUpperCase();
            if(!init) { playSound('error'); return alert("Initials or Face ID required!"); }
            
            if(activeStackIndex >= 0) {
                // Update the specific stack in the array
                repeatableStacks[activeStackIndex].current++; 
                
                // SAVE STACK STATE
                appState.stackCounts[activeStackIndex] = repeatableStacks[activeStackIndex].current;
                saveState();

                renderRepeatableSection();
                addToLog('TASK_COMPLETE', { task: activeTaskName, staff: init });
            } else {
                activeCard.classList.add('green');
                activeCard.classList.remove('overdue'); // Remove red if completed late
                activeCard.innerHTML = `
                    <span class="due-badge">${activeCard.querySelector('.due-badge').innerText}</span>
                    <strong>‚úÖ ${activeTaskName}</strong>
                    <div class="card-subtext">By ${init}</div>`;
                activeCard.onclick = null;
                
                // SAVE TASK STATE
                appState.completedTasks[activeTaskName] = init;
                saveState();

                addToLog('TASK_COMPLETE', { task: activeTaskName, staff: init });
                
                const listId = activeCard.parentElement.id;
                if(listId === 'openingList') updateSectionStatus('openingList', 'openingTitle', 'openingArrow');
                if(listId === 'closingList') updateSectionStatus('closingList', 'closingTitle', 'closingArrow');
            }
            playSound('success'); closeModal('sign-modal');
        }
    </script>
</body>
</html>